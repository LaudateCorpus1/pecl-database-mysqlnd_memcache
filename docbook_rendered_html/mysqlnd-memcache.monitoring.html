<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>PHP Manual: Monitoring</title>

</head>
<body>
<table width="100%">
    <tr valign="top">
        <td style="font-size: smaller;" width="15%">
<style type="text/css">
#leftbar {
	float: left;
	width: 186px;
	padding: 5px;
	font-size: smaller;
}
ul.toc {
	margin: 0px 5px 5px 5px;
	padding: 0px;
}
ul.toc li {
	font-size: 85%;
	margin: 1px 0 1px 1px;
	padding: 1px 0 1px 11px;
	list-style-type: none;
	background-repeat: no-repeat;
	background-position: center left;
}
ul.toc li.header {
	font-size: 115%;
	padding: 5px 0px 5px 11px;
	border-bottom: 1px solid #cccccc;
	margin-bottom: 5px;
}
ul.toc li.active {
	font-weight: bold;
}
ul.toc li a {
	text-decoration: none;
}
ul.toc li a:hover {
	text-decoration: underline;
}
</style>
 <ul class="toc">
  <li class="header home"><a href="index.html">PHP Manual</a></li>
  <li class="header up"><a href="funcref.html">Function Reference</a></li>
  <li class="header up"><a href="refs.database.html">Database Extensions</a></li>
  <li class="header up"><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>
  <li class="header up"><a href="set.mysqlinfo.html">MySQL</a></li>
  <li class="header up"><a href="book.mysqlnd-memcache.html">mysqlnd_memcache</a></li>
  <li class="header up"><a href="mysqlnd-memcache.setup.html">Installing/Configuring</a></li>
  <li><a href="mysqlnd-memcache.requirements.html">Requirements</a></li>
  <li><a href="mysqlnd-memcache.installation.html">Installation</a></li>
  <li><a href="mysqlnd-memcache.configuration.html">Runtime Configuration</a></li>
  <li><a href="mysqlnd-memcache.plugin-ini-json.html">Plugin configuration file (&gt;=1.1.x)</a></li>
  <li><a href="mysqlnd-memcache.plugin-ini-v1.html">Plugin configuration file (&lt;= 1.0.x)</a></li>
  <li><a href="mysqlnd-memcache.testing.html">Testing</a></li>
  <li><a href="mysqlnd-memcache.debugging.html">Debugging and Tracing</a></li>
  <li class="active"><a href="mysqlnd-memcache.monitoring.html">Monitoring</a></li>
 </ul>

        </td>
        <td width="85%">
            <div style="text-align: center;">
                <div class="prev" style="text-align: left; float: left;"><a href="mysqlnd-memcache.debugging.html">Debugging and Tracing</a></div>
                <div class="next" style="text-align: right; float: right;"><a href="mysqlnd-memcache.constants.html">Predefined Constants</a></div>
                <div class="up"><a href="mysqlnd-memcache.setup.html">Installing/Configuring</a></div>
                <div class="home"><a href="index.html">PHP Manual</a></div>
            </div><hr/>
<div id="mysqlnd-memcache.monitoring" class="section">
  <h2 class="title">Monitoring</h2>
  <p class="para">
   Plugin activity can be monitored using the mysqlnd trace log,
   mysqlnd statistics, mysqlnd_ms plugin statistics and external PHP debugging tools.
   Use of the trace log should be limited to debugging. It is recommended
   to use the plugins statistics for monitoring.
  </p>
  <p class="para">
   Writing a trace log is a slow operation. If using an external PHP debugging tool,
   please refer to the vendors manual about its perfomance impact and the
   type of information collected. In many cases, external debugging tools will
   provide call stacks. Often, a call stack or a trace log is more difficult to interpret
   than the statistics provided by the plugin.
  </p>
  <p class="para">
   Plugin statistics tell how often which kind of cluster node has been used (slave or master),
   why the node was used, if lazy connections have been used and if global transaction
   ID injection has been performed. The monitoring information provided enables
   user to verify plugin decisions and to plan their cluster resources based on usage pattern.
   The function <span class="function">mysqlnd_ms_get_stats</span>
   is used to access the statistics. Please, see the functions description for a list
   of available statistics.
  </p>
  <p class="para">
   Statistics are collected on a per PHP process basis. Their scope is a PHP process.
   Depending on the PHP deployment model a process may serve one or multiple web requests.
   If using CGI model, a PHP process serves one web request. If using FastCGI or
   pre-fork web server models, a PHP process usually serves multiple web requests.
   The same is the case with a threaded web server. Please, note that threads running
   in parallel can update the statistics in parallel. Thus, if using a threaded PHP
   deployment model, statistics can be changed by more than one script at a time. A
   script cannot rely on the fact that it sees only its own changes to statistics.
  </p>
  <p class="para">
   <div class="example">
    <p><b>Example #1 Verify plugin activity in a non-threaded deployment model</b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;Load&nbsp;balanced&nbsp;following&nbsp;"myapp"&nbsp;section&nbsp;rules&nbsp;from&nbsp;the&nbsp;plugins&nbsp;config&nbsp;file&nbsp;(not&nbsp;shown)&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())<br />&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;Of&nbsp;course,&nbsp;your&nbsp;error&nbsp;handling&nbsp;is&nbsp;nicer...&nbsp;*/<br />&nbsp;&nbsp;</span><span style="color: #007700">die(</span><span style="color: #0000BB">sprintf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">()));<br /><br /></span><span style="color: #0000BB">$stats_before&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br />if&nbsp;(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;'Read&nbsp;request'&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch_all</span><span style="color: #007700">());<br />}<br /></span><span style="color: #0000BB">$stats_after&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">();<br />if&nbsp;(</span><span style="color: #0000BB">$stats_after</span><span style="color: #007700">[</span><span style="color: #DD0000">'use_slave'</span><span style="color: #007700">]&nbsp;&lt;=&nbsp;</span><span style="color: #0000BB">$stats_before</span><span style="color: #007700">[</span><span style="color: #DD0000">'use_slave'</span><span style="color: #007700">])&nbsp;{<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"According&nbsp;to&nbsp;the&nbsp;statistics&nbsp;the&nbsp;read&nbsp;request&nbsp;has&nbsp;not&nbsp;been&nbsp;run&nbsp;on&nbsp;a&nbsp;slave!"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   Statistics are aggregated for all plugin activities and all connections handled by
   the plugin. It is not possible to tell how much a certain connection handle has
   contributed to the overall statistics.
  </p>
  <p class="para">
   Utilizing PHPs <span class="function">register_shutdown_function</span> function or the
   <i>auto_append_file</i> PHP configuration directive it is
   easily possible to dump statistics into, for example, a log file when a script
   finishes. Instead of using a log file it is also possible to send the statistics
   to an external monitoring tool for recording and display.
  </p>
  <p class="para">
   <div class="example">
    <p><b>Example #2 Recording statistics during shutdown</b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">mysqlnd_ms.enable=1
mysqlnd_ms.collect_statistics=1
error_log=/tmp/php_errors.log</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">check_stats</span><span style="color: #007700">()&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">var_export</span><span style="color: #007700">(</span><span style="color: #0000BB">mysqlnd_ms_get_stats</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$msg&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;</span><span style="color: #0000BB">error_log</span><span style="color: #007700">(</span><span style="color: #0000BB">$msg</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">register_shutdown_function</span><span style="color: #007700">(</span><span style="color: #DD0000">"check_stats"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>
        </td>
    </tr>
</table>
</body>
</html>
